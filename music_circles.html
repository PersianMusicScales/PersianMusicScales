<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interactive Music Circles</title>
  <style>
    body {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      background-color: #f4f4f4;
      font-family: Arial, sans-serif;
      height: 100vh;
      overflow: hidden;
    }
    .title {
      text-align: center;
      font-size: 24px;
      font-weight: bold;
      margin: 10px 0;
      color: #333;
    }
    .main-content {
      display: flex;
      flex-grow: 1;
      width: 100%;
    }
    .menu {
      width: 200px;
      background-color: #eee;
      padding: 10px;
      box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      height: 100%;
      box-sizing: border-box;
    }
    .menu h3 {
      margin: 0 0 10px;
      text-align: center;
    }
    .menu button {
      display: block;
      width: 100%;
      margin: 5px 0;
      padding: 10px;
      font-size: 16px;
      border: none;
      background-color: #ddd;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .menu button:hover {
      background-color: #ccc;
    }
    .container {
      flex-grow: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    .outer-circle {
      position: absolute;
      width: 400px;
      height: 400px;
      background-size: cover;
      background-position: center;
      border-radius: 50%;
    }
    .alignment-marker {
      position: absolute;
      top: 110px;
      left: 50%;
      transform: translateX(-50%);
      width: 10px;
      height: 10px;
      background-color: red;
      border-radius: 50%;
      border: 2px solid white;
      z-index: 10;
    }
    .marker-label {
      position: absolute;
      top: 90px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      font-weight: bold;
      color: #333;
      text-align: center;
    }
    .inner-circle {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 200px;
      height: 200px;
      background: url('inner-circle.png') no-repeat center/cover;
      border-radius: 50%;
      transform: translate(-50%, -50%);
      cursor: pointer;
    }
    .footer {
      text-align: center;
      font-size: 14px;
      color: #555;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="title" id="scaleTitle">Shur</div>
  
  <div class="main-content">
    <div class="menu">
      <h3>Persian Music Scales</h3>
      <button data-circle="Shur">Shur</button>
      <button data-circle="Nava">Nava</button>
      <button data-circle="Segah">Segah</button>
      <button data-circle="Homayoun">Homayoun</button>
      <button data-circle="Esfahan">Esfahan</button>
      <button data-circle="Chahargah">Chahargah</button>
      <button data-circle="Mahur">Mahur</button>
    </div>

    <div class="container">
      <div class="outer-circle" id="outerCircle" style="background: url('Shur.png') no-repeat center/cover;"></div>
      <div class="alignment-marker"></div>
      <div class="marker-label">Align Here</div>
      <div class="inner-circle" id="innerCircle"></div>
    </div>
  </div>

  <div class="footer">
    &copy; 2024 Pouya Hosseini. All rights reserved.
  </div>

  <script>
    const innerCircle = document.getElementById("innerCircle");
    const outerCircle = document.getElementById("outerCircle");
    const scaleTitle = document.getElementById("scaleTitle");
    const buttons = document.querySelectorAll(".menu button");
    const outerLabels = ["Do", "Re", "Mi", "Fa", "Sol", "La", "Si"]; // Labels for outer circle
    const labelElements = []; // For dynamically adding labels to the outer circle

    let isDragging = false;
    let startAngle = 0;
    let currentRotation = 0;
    let targetRotation = 0;
    const snapThreshold = 10 * (Math.PI / 180); // 10 degrees in radians

    // Calculate the rotation angle of an element
    function calculateAngle(clientX, clientY, rect) {
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      return Math.atan2(clientY - centerY, clientX - centerX);
    }

    // Snap rotation to the closest alignment if within threshold
    function snapToAlignment(rotation) {
      const segmentAngle = (2 * Math.PI) / outerLabels.length; // Angle between labels
      const remainder = rotation % segmentAngle;
      if (Math.abs(remainder) < snapThreshold || Math.abs(remainder - segmentAngle) < snapThreshold) {
        return Math.round(rotation / segmentAngle) * segmentAngle;
      }
      return rotation;
    }

    // Smoothly transition to the target rotation
    function animateRotation() {
      if (Math.abs(currentRotation - targetRotation) < 0.001) {
        currentRotation = targetRotation; // Snap to final position if close
        return;
      }

      currentRotation += (targetRotation - currentRotation) * 0.1; // Ease rotation
      innerCircle.style.transform = `translate(-50%, -50%) rotate(${currentRotation}rad)`;

      // Detect alignment and update labels
      const alignedIndex = Math.round(currentRotation / ((2 * Math.PI) / outerLabels.length)) % outerLabels.length;
      updateOuterLabels((outerLabels.length - alignedIndex) % outerLabels.length);

      requestAnimationFrame(animateRotation);
    }

    // Update outer circle labels
    function updateOuterLabels(startLabelIndex) {
      const outerRadius = 200; // Outer circle radius
      const labelRadius = outerRadius + 20; // Distance from circle center for labels
      const centerX = outerCircle.offsetWidth / 2;
      const centerY = outerCircle.offsetHeight / 2;

      // Clear existing labels
      labelElements.forEach((el) => el.remove());
      labelElements.length = 0;

      // Add labels dynamically
      for (let i = 0; i < outerLabels.length; i++) {
        const angle = (i * 2 * Math.PI) / outerLabels.length - Math.PI / 2;
        const x = centerX + labelRadius * Math.cos(angle);
        const y = centerY + labelRadius * Math.sin(angle);

        const label = document.createElement("div");
        label.style.position = "absolute";
        label.style.left = `${x}px`;
        label.style.top = `${y}px`;
        label.style.transform = "translate(-50%, -50%)";
        label.style.fontSize = "14px";
        label.style.fontWeight = "bold";
        label.style.color = "#333";
        label.textContent = outerLabels[(startLabelIndex + i) % outerLabels.length];
        outerCircle.appendChild(label);
        labelElements.push(label);
      }
    }

    // Event: Start dragging
    innerCircle.addEventListener("mousedown", (e) => {
      isDragging = true;
      const rect = innerCircle.getBoundingClientRect();
      startAngle = calculateAngle(e.clientX, e.clientY, rect);
      currentRotation = parseFloat(innerCircle.dataset.rotation) || 0;
      targetRotation = currentRotation;
    });

    // Event: Dragging
    window.addEventListener("mousemove", (e) => {
      if (!isDragging) return;

      const rect = innerCircle.getBoundingClientRect();
      const currentAngle = calculateAngle(e.clientX, e.clientY, rect);
      targetRotation = currentRotation + currentAngle - startAngle;

      targetRotation = snapToAlignment(targetRotation); // Snap if close to alignment
      innerCircle.dataset.rotation = targetRotation;

      animateRotation();
    });

    // Event: Stop dragging
    window.addEventListener("mouseup", () => {
      isDragging = false;
    });

    // Event: Change outer circle
    buttons.forEach((button) => {
      button.addEventListener("click", () => {
        const circleName = button.dataset.circle;
        outerCircle.style.background = `url('${circleName}.png') no-repeat center/cover`;
        scaleTitle.textContent = circleName; // Update title
        updateOuterLabels(0); // Reset labels
      });
    });

    // Initial label setup
    updateOuterLabels(0);
  </script>
</body>
</html>
